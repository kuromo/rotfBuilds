/*! rotfBuilds - v0.0.0 - 2019-01-24
* Copyright (c) 2019 ;*/

var gSrv="http://localhost:3000/";function toggleSmRune(t){$(".smRune[data-stat='"+t+"']").toggleClass("active"),updateStats()}function importTree(){srvPost("importTree",console.log,{tree:JSON.stringify(tree)})}function getTree(){srvGet("getTree",function(t){console.log(t)})}function ceckStart(){if($(".start").hasClass("activeNode"))return!0;console.log("select start")}function secStart(t){var e=$(".activeNode.start");e.toggleClass("activeNode"),$(t).toggleClass("activeNode");var a=checkUncon();a&&handleUncon(t,a,e),updateStats()}function getAdjac(t){var e,a=parseInt(t.split("c")[0].replace(/r/g,"")),s=parseInt(t.split("c")[1]),o={};1!=a&&checkAloc(a-1,s)&&(o[(e=$(".tile[data-id='r"+(a-1)+"c"+s+"']")).attr("data-id")]=e);13!=s&&checkAloc(a,s+1)&&(o[(e=$(".tile[data-id='r"+a+"c"+(s+1)+"']")).attr("data-id")]=e);15!=a&&checkAloc(a+1,s)&&(o[(e=$(".tile[data-id='r"+(a+1)+"c"+s+"']")).attr("data-id")]=e);1!=s&&checkAloc(a,s-1)&&(o[(e=$(".tile[data-id='r"+a+"c"+(s-1)+"']")).attr("data-id")]=e);return!!hasProp(o)&&o}function checkAloc(t,e){return $(".tile[data-id='r"+t+"c"+e+"']").hasClass("activeNode")}function checkUncon(){for(var t=breadthFirst(),e=$(".activeNode"),a={},s=0;s<e.length;s++){var o=$(e[s]).attr("data-id");t[o]||(a[o]=e[s])}return!!hasProp(a)&&a}function breadthFirst(){for(var t=$(".activeNode.start"),e={},a=[e[$(t).attr("data-id")]=t];a.length;){var s=a.shift(),o=getAdjac($(s).attr("data-id"));for(var r in o){var n=o[r];e[r]||(e[r]=n,a.push(n))}}return e}function handleUncon(t,e,a){var s=$(t).attr("data-id"),o=$(a).attr("data-id"),r="";for(var n in e)r+=n,r+=",";if(r=r.slice(0,-1),$(t).hasClass("start"))var i='<h5 class="modal-title">Start cahnge</h5>',l="newSt:"+statById(s).toModal()+"oldSt:"+statById(o).toModal()+"<h3>some nodes are unconnected</h3>"+statById(r).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+r+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+s+","+o+"')\">Keep Old</button>";else i='<h5 class="modal-title">Unconnected ndoes</h5>',l="unalocated node:"+statById(s).toModal()+"will be unconnected:"+statById(r).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+r+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+s+"')\">Undo</button>";createModal(i,l,c)}function toggleNodes(t){for(var e in t=t.split(","))$(".tile[data-id='"+t[e]+"']").toggleClass("activeNode");window.setTimeout(function(){$("#treeModal").remove()},500),updateStats()}function statById(t){var e=new TStats;for(var a in t=t.split(",")){var s=t[a].split("c")[0],o="c"+t[a].split("c")[1];if("start"==tree[s][o].type)for(var r in stNodes[tree[s][o].val])e[r]+=stNodes[tree[s][o].val][r];else e[tree[s][o].type]+=tree[s][o].val}return console.log(e.getActive()),e.getActive()}function TStats(){this.vit=0,this.vitPre=0,this.dex=0,this.dexPre=0,this.lootPre=0,this.mp=0,this.mpPre=0,this.eva=0,this.evaPre=0,this.spd=0,this.spdPre=0,this.hp=0,this.hpPre=0,this.wis=0,this.wisPre=0,this.rof=0,this.atk=0,this.atkPre=0,this.def=0,this.defPre=0}function calcTreeStat(){var s=new TStats;return $(".activeNode").each(function(){var t=$(this).data("id"),e=t.split("c")[0],a="c"+t.split("c")[1];"start"==tree[e][a].type?calcStart(tree[e][a].val,s):s[tree[e][a].type]+=tree[e][a].val}),s}function calcStart(t,e){for(var a in stNodes[t])e[a]+=stNodes[t][a]}function changeClass(t){console.log(t);var e="/img/classes/"+t+".png";$(".classIcon").attr("src",e),$(".classIcon").attr("data-class",t),$("#classDD").toggleClass("show"),$(".classDDBtn:not(.collapsed)").toggleClass("collapsed"),updateStats()}function updateStats(){var t=calcTreeStat(),e=getSmRuneStats(),a=$(".classIcon").attr("data-class"),s=classes[a].stats;console.log("tStats: "),console.log(t),console.log("smRuneStats: "),console.log(e),console.log("classStats: "),console.log(s),console.log("stat sum"),console.log(sumObjectsByKey([t,e,s])),renderStats(sumObjectsByKey([t,e,s]))}function renderStats(t){$("#hpBar").html(t.hp),$("#mpBar").html(t.mp),$("#atkStat .statValue").html(t.atk),$("#defStat .statValue").html(t.def),$("#spdStat .statValue").html(t.spd),$("#dexStat .statValue").html(t.dex),$("#vitStat .statValue").html(t.vit),$("#wisStat .statValue").html(t.wis)}function getSmRuneStats(){var t={};return $(".smRune.active").each(function(){t[$(this).attr("data-stat")]=parseInt($(this).attr("data-value"))}),t}function login(){var t=$("#usrName").val(),e=$("#usrPwd").val();console.log(t+"   "+e),srvPost("login",console.log,{usrName:t,pwd:e})}function logout(){srvGet("logout",console.log)}function register(){var t={usrName:$("#usrName").val(),mail:$("#mail").val(),firstName:$("#firstName").val(),lastName:$("#lastName").val(),pwd:$("#usrPwd").val()};console.log(t),srvPost("register",console.log,t)}function forgot(){var t=$("#mail").val();srvPost("forgot",console.log,{mail:t})}function reset(){var t=$("#usrPwd").val();srvPost(window.location.pathname.substring(1),console.log,{pwd:t})}function srvGet(t,e,a){$.ajax({type:"GET",data:{},url:gSrv+t,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),a?e(t,a):e(t),t},error:function(t){console.log(t),outputError(t)}})}function srvPost(t,e,a){$.ajax({type:"POST",url:gSrv+t,data:a,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),e(t),t},error:function(t){console.log(t),outputError(t)}})}function outputError(t){}function hasProp(t){for(var e in t)if(t.hasOwnProperty(e))return!0;return!1}function sumObjectsByKey(t){return t.reduce(function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=(t[a]||0)+e[a]);return t},{})}function createModal(t,e,a){var s='<div id="treeModal" class="modal" tabindex="-1" role="dialog" show="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">'+t+'</div><div class="modal-body">'+e+'</div><div class="modal-footer">'+a+"</div></div></div></div>";$("#mainCont").append(s),$("#treeModal").modal({backdrop:"static",keyboard:!1}),$("#treeModal").modal("show")}$(function(){skrollr.init()}),$(function(){$(".tile").click(function(){console.log(this);var t=$(".activeNode");if(!$(this).hasClass("start")&&!ceckStart())return!1;if($(this).hasClass("start")&&!$(".activeNode").hasClass("start"));else if($(this).hasClass("activeNode")){if($(this).hasClass("start")&&1!=t.length)return console.log("cant remove start"),!1}else{if(!getAdjac($(this).data("id")))return console.log("not connected to start"),!1;if(!(t.length<82))return console.log("no poits left"),!1;if($(this).hasClass("start"))return secStart(this),!1}$(this).toggleClass("activeNode");var e=checkUncon();e&&handleUncon(this,e),updateStats()})}),TStats.prototype.getFlat=function(){return{vit:this.vit,dex:this.dex,mp:this.mp,eva:this.eva,spd:this.spd,hp:this.hp,wis:this.wis,rof:this.rof,atk:this.atk,def:this.def}},TStats.prototype.getPre=function(){return{vitPre:this.vitPre,dexPre:this.dexPre,lootPre:this.lootPre,mpPre:this.mpPre,evaPre:this.evaPre,spdPre:this.spdPre,hpPre:this.hpPre,wisPre:this.wisPre,atkPre:this.atkPre,defPre:this.defPre}},TStats.prototype.getActive=function(){var t={};for(var e in this)0!=this[e]&&(t[e]=this[e]);return t},TStats.prototype.toModal=function(){var t='<div class="modalStats">';for(var e in this)"function"!=typeof this[e]&&(t+="<b>"+e+": </b>"+this[e]+"<br/>");return t+="</div>"},$(function(){$("#navLogBtn").click(function(){if($("#navUsr").attr("hidden"))$("#navUsr").attr("hidden",!1),$("#navPwd").attr("hidden",!1);else{var t=$("#navUsr").val(),e=$("#navPwd").val();srvPost("login",console.log,{usrName:t,pwd:e})}})});