/*! rotfBuilds - v0.0.0 - 2019-01-27
* Copyright (c) 2019 ;*/

var gSrv="http://localhost:3000/";function toggleSmRune(t){$(".smRune[data-stat='"+t+"']").toggleClass("active"),updateStats()}function getSmRuneStats(){var t={};return $(".smRune.active").each(function(){t[$(this).attr("data-stat")]=parseInt($(this).attr("data-value"))}),t}function changeBRune(t,e){var a="/img/runes/"+e+".png";$(".rune"+t+"Icon").attr("src",a),$(".rune"+t+"Icon").attr("data-rune",e),$("#rune"+t+"DD").toggleClass("show"),$("."+t+"DDBtn:not(.collapsed)").toggleClass("collapsed"),updateStats()}function getBRuneStats(){var t=$(".runeRedIcon").attr("data-rune"),e=t?bRunes[t].stats:{},a=$(".runeGreenIcon").attr("data-rune"),s=a?bRunes[a].stats:{},o=$(".runeBlueIcon").attr("data-rune"),r=o?bRunes[o].stats:{},n=$(".runeAllIcon").attr("data-rune"),l=sumObjectsByKey([e,s,r,n?bRunes[n].stats:{}]);return console.log("bNode stats:"),console.log(l),t&&bRunes[t].special&&(console.log("rRune special"),console.log(bRunes[t].special)),a&&bRunes[a].special&&(console.log("gRune special"),console.log(bRunes[a].special)),o&&bRunes[o].special&&(console.log("bRune special"),console.log(bRunes[o].special)),n&&bRunes[n].special&&(console.log("aRune special"),console.log(bRunes[n].special)),l}function importTree(){srvPost("importTree",console.log,{tree:JSON.stringify(tree)})}function getTree(){srvGet("getTree",function(t){console.log(t)})}function saveTree(){var t=[];$(".activeNode").each(function(){t.push($(this).attr("data-id"))}),console.log(t)}function loadTree(){var nodes=eval($("#loadTxt").val());for(var x in $(".activeNode").toggleClass("activeNode"),nodes)$(".tile[data-id="+nodes[x]+"]").toggleClass("activeNode")}function ceckStart(){if($(".start").hasClass("activeNode"))return!0;console.log("select start")}function secStart(t){var e=$(".activeNode.start");e.toggleClass("activeNode"),$(t).toggleClass("activeNode");var a=checkUncon();a&&handleUncon(t,a,e),updateStats()}function getAdjac(t){var e,a=parseInt(t.split("c")[0].replace(/r/g,"")),s=parseInt(t.split("c")[1]),o={};1!=a&&checkAloc(a-1,s)&&(o[(e=$(".tile[data-id='r"+(a-1)+"c"+s+"']")).attr("data-id")]=e);13!=s&&checkAloc(a,s+1)&&(o[(e=$(".tile[data-id='r"+a+"c"+(s+1)+"']")).attr("data-id")]=e);15!=a&&checkAloc(a+1,s)&&(o[(e=$(".tile[data-id='r"+(a+1)+"c"+s+"']")).attr("data-id")]=e);1!=s&&checkAloc(a,s-1)&&(o[(e=$(".tile[data-id='r"+a+"c"+(s-1)+"']")).attr("data-id")]=e);return!!hasProp(o)&&o}function checkAloc(t,e){return $(".tile[data-id='r"+t+"c"+e+"']").hasClass("activeNode")}function checkUncon(){for(var t=breadthFirst(),e=$(".activeNode"),a={},s=0;s<e.length;s++){var o=$(e[s]).attr("data-id");t[o]||(a[o]=e[s])}return!!hasProp(a)&&a}function breadthFirst(){for(var t=$(".activeNode.start"),e={},a=[e[$(t).attr("data-id")]=t];a.length;){var s=a.shift(),o=getAdjac($(s).attr("data-id"));for(var r in o){var n=o[r];e[r]||(e[r]=n,a.push(n))}}return e}function handleUncon(t,e,a){var s=$(t).attr("data-id"),o=$(a).attr("data-id"),r="";for(var n in e)r+=n,r+=",";if(r=r.slice(0,-1),$(t).hasClass("start"))var l='<h5 class="modal-title">Start cahnge</h5>',i="newSt:"+statById(s).toModal()+"oldSt:"+statById(o).toModal()+"<h3>some nodes are unconnected</h3>"+statById(r).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+r+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+s+","+o+"')\">Keep Old</button>";else l='<h5 class="modal-title">Unconnected ndoes</h5>',i="unalocated node:"+statById(s).toModal()+"will be unconnected:"+statById(r).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+r+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+s+"')\">Undo</button>";createModal(l,i,c)}function toggleNodes(t){for(var e in t=t.split(","))$(".tile[data-id='"+t[e]+"']").toggleClass("activeNode");window.setTimeout(function(){$("#treeModal").remove()},500),updateStats()}function statById(t){var e=new TStats;for(var a in t=t.split(",")){var s=t[a].split("c")[0],o="c"+t[a].split("c")[1];if("start"==tree[s][o].type)for(var r in stNodes[tree[s][o].val])e[r]+=stNodes[tree[s][o].val][r];else e[tree[s][o].type]+=tree[s][o].val}return console.log(e.getActive()),e.getActive()}function TStats(){this.vit=0,this.vitPre=0,this.dex=0,this.dexPre=0,this.lootPre=0,this.mp=0,this.mpPre=0,this.eva=0,this.evaPre=0,this.spd=0,this.spdPre=0,this.hp=0,this.hpPre=0,this.wis=0,this.wisPre=0,this.rof=0,this.atk=0,this.atkPre=0,this.def=0,this.defPre=0}function calcTreeStat(){var s=new TStats;return $(".activeNode").each(function(){var t=$(this).data("id"),e=t.split("c")[0],a="c"+t.split("c")[1];"start"==tree[e][a].type?calcStart(tree[e][a].val,s):s[tree[e][a].type]+=tree[e][a].val}),s}function calcStart(t,e){for(var a in stNodes[t])e[a]+=stNodes[t][a]}function changeClass(t){console.log(t);var e="/img/classes/"+t+".png";$(".classIcon").attr("src",e),$(".classIcon").attr("data-class",t),$("#classDD").toggleClass("show"),$(".classDDBtn:not(.collapsed)").toggleClass("collapsed"),updateStats()}function updateStats(){var t=calcTreeStat(),e=getSmRuneStats(),a=getBRuneStats(),s=$(".classIcon").attr("data-class"),o=s?classes[s].stats:{},r=calcIncreases(sumObjectsByKey([getGearStats(),t.getPre(),e,a,o])),n=sumObjectsByKey([t.getFlat(),r]);renderStats(n),calcAdvStats(n)}function renderStats(t){$("#hpBar").html(t.hp),$("#mpBar").html(t.mp),$("#atkStat .statValue").html(t.atk),$("#defStat .statValue").html(t.def),$("#spdStat .statValue").html(t.spd),$("#dexStat .statValue").html(t.dex),$("#vitStat .statValue").html(t.vit),$("#wisStat .statValue").html(t.wis)}function calcIncreases(t){return t.hp=t.hp*(1+t.hpPre/100),t.mp=t.mp*(1+t.mpPre/100),t.atk=t.atk*(1+t.atkPre/100),t.def=t.def*(1+t.defPre/100),t.spd=t.spd*(1+t.spdPre/100),t.dex=t.dex*(1+t.dexPre/100),t.vit=t.vit*(1+t.vitPre/100),t.wis=t.wis*(1+t.wisPre/100),t}function getGearStats(){var t={};return t.hp=parseInt($("#hpTxt").val()),t.mp=parseInt($("#mpTxt").val()),t.atk=parseInt($("#atkTxt").val()),t.def=parseInt($("#defTxt").val()),t.spd=parseInt($("#spdTxt").val()),t.dex=parseInt($("#dexTxt").val()),t.vit=parseInt($("#vitTxt").val()),t.wis=parseInt($("#wisTxt").val()),t.avgDmg=(parseInt($("#minDmgTxt").val())+parseInt($("#maxDmgTxt").val())-1)/2,t.shots=parseInt($("#shotsTxt").val()),t.rof=parseInt($("#rofTxt").val())-100,t}function calcAdvStats(t){var e=t;e.hpps=1+.12*t.vit,e.mpps=.5+.06*t.wis,e.defCap=t.def+t.def/85*15,e.tps=4+t.spd/75*5.6,e.dexAps=1.5+t.dex/75*6.5,e.aps=e.dexAps*(1+t.rof/100),e.atkMulti=1.5+t.atk/75*6.5,e.dps=t.avgDmg*e.atkMulti*t.shots*e.aps,console.log("advStats"),console.log(e),renderAdvStats(e)}function renderAdvStats(t){var e=t.hpps*(1+(t.hReg||0)/100)+" ("+t.hpps+")",a=t.mpps*(1+(t.mReg||0)/100)+" ("+t.mpps+")";$("#hppsStat .statValue").html(e),$("#mppsStat .statValue").html(a),$("#defCapStat .statValue").html(t.defCap),$("#tpsStat .statValue").html(t.tps),$("#dexApsStat .statValue").html(t.dexAps),$("#apsStat .statValue").html(t.aps),$("#dpsStat .statValue").html(t.dps)}function login(){var t=$("#usrName").val(),e=$("#usrPwd").val();console.log(t+"   "+e),srvPost("login",console.log,{usrName:t,pwd:e})}function logout(){srvGet("logout",console.log)}function register(){var t={usrName:$("#usrName").val(),mail:$("#mail").val(),firstName:$("#firstName").val(),lastName:$("#lastName").val(),pwd:$("#usrPwd").val()};console.log(t),srvPost("register",console.log,t)}function forgot(){var t=$("#mail").val();srvPost("forgot",console.log,{mail:t})}function reset(){var t=$("#usrPwd").val();srvPost(window.location.pathname.substring(1),console.log,{pwd:t})}function srvGet(t,e,a){$.ajax({type:"GET",data:{},url:gSrv+t,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),a?e(t,a):e(t),t},error:function(t){console.log(t),outputError(t)}})}function srvPost(t,e,a){$.ajax({type:"POST",url:gSrv+t,data:a,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),e(t),t},error:function(t){console.log(t),outputError(t)}})}function outputError(t){}function hasProp(t){for(var e in t)if(t.hasOwnProperty(e))return!0;return!1}function sumObjectsByKey(t){return t.reduce(function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=(t[a]||0)+e[a]);return t},{})}function createModal(t,e,a){var s='<div id="treeModal" class="modal" tabindex="-1" role="dialog" show="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">'+t+'</div><div class="modal-body">'+e+'</div><div class="modal-footer">'+a+"</div></div></div></div>";$("#mainCont").append(s),$("#treeModal").modal({backdrop:"static",keyboard:!1}),$("#treeModal").modal("show")}$(function(){skrollr.init()}),$(function(){$(".tile").click(function(){console.log(this);var t=$(".activeNode");if(!$(this).hasClass("start")&&!ceckStart())return!1;if($(this).hasClass("start")&&!$(".activeNode").hasClass("start"));else if($(this).hasClass("activeNode")){if($(this).hasClass("start")&&1!=t.length)return console.log("cant remove start"),!1}else{if(!getAdjac($(this).data("id")))return console.log("not connected to start"),!1;if(!(t.length<82))return console.log("no poits left"),!1;if($(this).hasClass("start"))return secStart(this),!1}$(this).toggleClass("activeNode");var e=checkUncon();e&&handleUncon(this,e),updateStats()})}),TStats.prototype.getFlat=function(){return{vit:this.vit,dex:this.dex,mp:this.mp,eva:this.eva,spd:this.spd,hp:this.hp,wis:this.wis,rof:this.rof,atk:this.atk,def:this.def}},TStats.prototype.getPre=function(){return{vitPre:this.vitPre,dexPre:this.dexPre,lootPre:this.lootPre,mpPre:this.mpPre,evaPre:this.evaPre,spdPre:this.spdPre,hpPre:this.hpPre,wisPre:this.wisPre,atkPre:this.atkPre,defPre:this.defPre}},TStats.prototype.getActive=function(){var t={};for(var e in this)0!=this[e]&&(t[e]=this[e]);return t},TStats.prototype.toModal=function(){var t='<div class="modalStats">';for(var e in this)"function"!=typeof this[e]&&(t+="<b>"+e+": </b>"+this[e]+"<br/>");return t+="</div>"},$(function(){$("#navLogBtn").click(function(){if($("#navUsr").attr("hidden"))$("#navUsr").attr("hidden",!1),$("#navPwd").attr("hidden",!1);else{var t=$("#navUsr").val(),e=$("#navPwd").val();srvPost("login",console.log,{usrName:t,pwd:e})}})});