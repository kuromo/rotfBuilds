/*! rotfBuilds - v0.0.0 - 2019-01-18
* Copyright (c) 2019 ;*/

var gSrv="http://localhost:3000/";function importTree(){srvPost("importTree",console.log,{tree:JSON.stringify(tree)})}function getTree(){srvGet("getTree",function(t){console.log(t)})}function ceckStart(){if($(".start").hasClass("activeNode"))return!0;console.log("select start")}function secStart(t){var e=$(".activeNode.start");e.toggleClass("activeNode"),$(t).toggleClass("activeNode");var a=checkUncon();a&&handleUncon(t,a,e),calcTreeStat()}function getAdjac(t){var e,a=parseInt(t.split("c")[0].replace(/r/g,"")),o=parseInt(t.split("c")[1]),r={};1!=a&&checkAloc(a-1,o)&&(r[(e=$(".tile[data-id='r"+(a-1)+"c"+o+"']")).attr("data-id")]=e);13!=o&&checkAloc(a,o+1)&&(r[(e=$(".tile[data-id='r"+a+"c"+(o+1)+"']")).attr("data-id")]=e);15!=a&&checkAloc(a+1,o)&&(r[(e=$(".tile[data-id='r"+(a+1)+"c"+o+"']")).attr("data-id")]=e);1!=o&&checkAloc(a,o-1)&&(r[(e=$(".tile[data-id='r"+a+"c"+(o-1)+"']")).attr("data-id")]=e);return!!hasProp(r)&&r}function checkAloc(t,e){return $(".tile[data-id='r"+t+"c"+e+"']").hasClass("activeNode")}function checkUncon(){for(var t=breadthFirst(),e=$(".activeNode"),a={},o=0;o<e.length;o++){var r=$(e[o]).attr("data-id");t[r]||(a[r]=e[o])}return!!hasProp(a)&&a}function breadthFirst(){for(var t=$(".activeNode.start"),e={},a=[e[$(t).attr("data-id")]=t];a.length;){var o=a.shift(),r=getAdjac($(o).attr("data-id"));for(var s in r){var i=r[s];e[s]||(e[s]=i,a.push(i))}}return e}function handleUncon(t,e,a){var o=$(t).attr("data-id"),r=$(a).attr("data-id"),s="";for(var i in e)s+=i,s+=",";if(s=s.slice(0,-1),$(t).hasClass("start"))var n='<h5 class="modal-title">Start cahnge</h5>',l="newSt:"+statById(o).toModal()+"oldSt:"+statById(r).toModal()+"<h3>some nodes are unconnected</h3>"+statById(s).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+s+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+o+","+r+"')\">Keep Old</button>";else n='<h5 class="modal-title">Unconnected ndoes</h5>',l="unalocated node:"+statById(o).toModal()+"will be unconnected:"+statById(s).toModal(),c='<button type="button" class="btn btn-primary" data-dismiss="modal" onClick="toggleNodes(\''+s+'\')">Remove</button><button type="button" class="btn btn-secondary" data-dismiss="modal" onClick="toggleNodes(\''+o+"')\">Undo</button>";createModal(n,l,c)}function toggleNodes(t){for(var e in t=t.split(","))$(".tile[data-id='"+t[e]+"']").toggleClass("activeNode");window.setTimeout(function(){$("#treeModal").remove()},500),calcTreeStat()}function statById(t){var e=new TStats;for(var a in t=t.split(",")){var o=t[a].split("c")[0],r="c"+t[a].split("c")[1];if("start"==tree[o][r].type)for(var s in stNodes[tree[o][r].val])e[s]+=stNodes[tree[o][r].val][s];else e[tree[o][r].type]+=tree[o][r].val}return console.log(e.getActive()),e.getActive()}function TStats(){this.vit=0,this.vitPre=0,this.dex=0,this.dexPre=0,this.lootPre=0,this.mp=0,this.mpPre=0,this.eva=0,this.evaPre=0,this.spd=0,this.spdPre=0,this.hp=0,this.hpPre=0,this.wis=0,this.wisPre=0,this.rof=0,this.atk=0,this.atkPre=0,this.def=0,this.defPre=0}function updateStats(t){var e="";for(var a in t){var o=t[a];Number.isInteger(o)&&0!==o&&(e+=a,e+=":  ",e+=o,e+="<br>")}$("#tStatCont").html(e);var r=$(".activeNode");$(".ptCount").text(r.length)}function calcTreeStat(){var o=new TStats;$(".activeNode").each(function(){var t=$(this).data("id"),e=t.split("c")[0],a="c"+t.split("c")[1];"start"==tree[e][a].type?calcStart(tree[e][a].val,o):o[tree[e][a].type]+=tree[e][a].val}),updateStats(o)}function calcStart(t,e){for(var a in stNodes[t])e[a]+=stNodes[t][a]}function login(){var t=$("#usrName").val(),e=$("#usrPwd").val();console.log(t+"   "+e),srvPost("login",console.log,{usrName:t,pwd:e})}function logout(){srvGet("logout",console.log)}function register(){var t={usrName:$("#usrName").val(),mail:$("#mail").val(),firstName:$("#firstName").val(),lastName:$("#lastName").val(),pwd:$("#usrPwd").val()};console.log(t),srvPost("register",console.log,t)}function forgot(){var t=$("#mail").val();srvPost("forgot",console.log,{mail:t})}function reset(){var t=$("#usrPwd").val();srvPost(window.location.pathname.substring(1),console.log,{pwd:t})}function srvGet(t,e,a){$.ajax({type:"GET",data:{},url:gSrv+t,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),a?e(t,a):e(t),t},error:function(t){console.log(t),outputError(t)}})}function srvPost(t,e,a){$.ajax({type:"POST",url:gSrv+t,data:a,beforeSend:function(){},success:function(t){return console.log(t.redirect),t.redirect&&(document.location.href=t.redirect),e(t),t},error:function(t){console.log(t),outputError(t)}})}function outputError(t){}function hasProp(t){for(var e in t)if(t.hasOwnProperty(e))return!0;return!1}function createModal(t,e,a){var o='<div id="treeModal" class="modal" tabindex="-1" role="dialog" show="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">'+t+'</div><div class="modal-body">'+e+'</div><div class="modal-footer">'+a+"</div></div></div></div>";$("#mainCont").append(o),$("#treeModal").modal({backdrop:"static",keyboard:!1}),$("#treeModal").modal("show")}$(function(){skrollr.init()}),$(function(){$(".tile").click(function(){console.log(this);var t=$(".activeNode");if(!$(this).hasClass("start")&&!ceckStart())return!1;if($(this).hasClass("start")&&!$(".activeNode").hasClass("start"));else if($(this).hasClass("activeNode")){if($(this).hasClass("start")&&1!=t.length)return console.log("cant remove start"),!1}else{if(!getAdjac($(this).data("id")))return console.log("not connected to start"),!1;if(!(t.length<82))return console.log("no poits left"),!1;if($(this).hasClass("start"))return secStart(this),!1}$(this).toggleClass("activeNode");var e=checkUncon();e&&handleUncon(this,e),calcTreeStat()})}),TStats.prototype.getFlat=function(){return{vit:this.vit,dex:this.dex,mp:this.mp,eva:this.eva,spd:this.spd,hp:this.hp,wis:this.wis,rof:this.rof,atk:this.atk,def:this.def}},TStats.prototype.getPre=function(){return{vitPre:this.vitPre,dexPre:this.dexPre,lootPre:this.lootPre,mpPre:this.mpPre,evaPre:this.evaPre,spdPre:this.spdPre,hpPre:this.hpPre,wisPre:this.wisPre,atkPre:this.atkPre,defPre:this.defPre}},TStats.prototype.getActive=function(){var t={};for(var e in this)0!=this[e]&&(t[e]=this[e]);return t},TStats.prototype.toModal=function(){var t='<div class="modalStats">';for(var e in this)"function"!=typeof this[e]&&(t+="<b>"+e+": </b>"+this[e]+"<br/>");return t+="</div>"},$(function(){$("#navLogBtn").click(function(){if($("#navUsr").attr("hidden"))$("#navUsr").attr("hidden",!1),$("#navPwd").attr("hidden",!1);else{var t=$("#navUsr").val(),e=$("#navPwd").val();srvPost("login",console.log,{usrName:t,pwd:e})}})});